graph TD
    A[HTTP Request] --> B[APIServer.handleRequest]
    B --> C[Parse URL: pathname, query]
    C --> D[Set req.query, req.params, req.body]
    D --> E[Capture request body with size limit]
    E --> F{bodySize > maxBodySize?}
    F -->|YES| G[413 Request Too Large]
    F -->|NO| H[End of data reception]
    H --> I{Is JSON content-type?}
    I -->|YES| J[Parse body as JSON]
    I -->|NO| K[Continue with raw body]
    J --> L{Is OPTIONS request?}
    K --> L
    L -->|YES| M[Execute CORS middleware]
    L -->|NO| N[Find matching route: findRoute(method, pathname)]
    M --> O{Has specific OPTIONS route?}
    O -->|YES| P[Add route params and execute handler]
    O -->|NO| Q[Send 204 No Content]
    N --> R{Route found?}
    R -->|NO| S[404 Not Found]
    R -->|YES| T[Add route params to req.params]
    T --> U[Execute registered middlewares in sequence]
    U --> V{Did middleware respond?}
    V -->|YES| W[End - Response sent]
    V -->|NO| X[Execute route handler]
    X --> Y{Is handler async?}
    Y -->|YES| Z[Await handler execution]
    Y -->|NO| AA[Execute handler synchronously]
    Z --> AB[End - Response sent]
    AA --> AB
    P --> AC[End - Response sent]
    
    BB[findRoute method] -.-> N
    BB -.-> DD[Check exact route match]
    DD --> EE{Exact match found?}
    EE -->|YES| FF[Return {route, empty params}]
    EE -->|NO| GG[Check parametrized routes]
    GG --> HH[Iterate through routes]
    HH --> II{Same HTTP method?}
    II -->|NO| JJ[Check next route]
    II -->|YES| KK[Convert route to regex: pathToRegex]
    KK --> LL{Does pathname match routeRegex?}
    LL -->|YES| MM[Extract params: extractParams]
    LL -->|NO| JJ
    MM --> NN[Return {route, extracted params}]
    JJ --> OO{More routes to check?}
    OO -->|YES| HH
    OO -->|NO| PP[Return null - No route found]
    
    QQ[Authentication Flow] -.-> RR[Authenticator.authenticate]
    RR --> SS[Get client IP]
    SS --> TT{Is IP blocked?}
    TT -->|YES| UU[403 Access denied by firewall]
    TT -->|NO| VV[Execute auth strategy]
    VV --> WW{Authentication successful?}
    WW -->|YES| XX[Log success, reset failed attempts, call next()]
    WW -->|NO| YY[Increment failed attempts, log failure, 401 Unauthorized]
    
    ZZ[Route Loading Flow] -.-> AAA[RouteLoader.loadRoutes]
    AAA --> BBB[Validate file exists]
    BBB --> CCC[Read and parse JSON routes]
    CCC --> DDD[Validate routes structure]
    DDD --> EEE[Iterate through each route]
    EEE --> FFF[Check route properties: method, path, controller, handler]
    FFF --> GGG[Load controller module]
    GGG --> HHH[Get handler function from controller]
    HHH --> III{Has custom contentType?}
    III -->|YES| JJJ[Create wrapper with setHeader]
    III -->|NO| KKK[Use handler directly]
    KKK --> LLL{Has authentication?}
    JJJ --> LLL
    LLL -->|YES| MMM[Apply authentication middleware]
    LLL -->|NO| NNN[Add route to server: server.addRoute]
    MMM --> NNN
    NNN --> OOO{More routes?}
    OOO -->|YES| EEE
    OOO -->|NO| PPP[Routes loaded successfully]
    
    QQQ[Firewall Flow] -.-> RRR[Firewall.middleware]
    RRR --> SSS[Get client IP]
    SSS --> TTT{Is IP blocked?}
    TTT -->|YES| UUU
    TTT -->|NO| VVV[Check rules: checkRules(req)]
    VVV --> WWW{Rule match found?}
    WWW -->|YES| XXX{Action is block?}
    WWW -->|NO| YYY[Allow request, call next()]
    XXX -->|YES| ZZZ[Increment failed attempts, 403 Forbidden]
    XXX -->|NO| AAAA[Continue with monitoring]
    AAAA --> YYY
    
    BBBB[View Engine Flow] -.-> CCCC[ViewEngine.render]
    CCCC --> DDDD[Get view path: getViewPath]
    DDDD --> EEEE{View file exists?}
    EEEE -->|NO| FFFF[Error: View not found]
    EEEE -->|YES| GGGG{Cache enabled and in cache?}
    GGGG -->|YES| HHHH[Get from cache]
    GGGG -->|NO| IIII[Read view content]
    IIII --> JJJJ[Process includes: processIncludes]
    JJJJ --> KKKK{Enable caching?}
    KKKK -->|YES| LLLL[Save to cache]
    KKKK -->|NO| MMMM[Continue without caching]
    LLLL --> NNNN[Process template: processTemplate]
    MMMM --> NNNN
    NNNN --> OOOO[Process foreach loops]
    OOOO --> PPPP[Process conditionals]
    PPPP --> QQQQ[Replace variables and filters]
    QQQQ --> RRRR[Return processed template]
    
    SSSS[Session Flow] -.-> TTTT[SessionManager.middleware]
    TTTT --> UUUU{Has session cookie?}
    UUUU -->|NO| VVVV[Create new session]
    UUUU -->|YES| WWWW[Validate existing session]
    VVVV --> XXXX[Add req.session]
    WWWW --> YYYY{Session valid?}
    YYYY -->|NO| VVVV
    YYYY -->|YES| ZZZZ[Update last activity]
    ZZZZ --> XXXX
    XXXX --> AAAAB[Call next()]
    
    BBBB -.-> CCCC
    QQ -.-> AAA
    ZZ -.-> BBB
    QQQ -.-> RRR
    BBBB -.-> CCCC